// Prisma schema for X-Ray execution tracing
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main execution record
model Execution {
  id            String      @id @default(cuid())
  executionId   String      @unique // User-facing ID (e.g., movie-exec-...)
  projectId     String      @default("default")
  metadata      Json?
  finalOutcome  Json?
  startedAt     DateTime    @default(now())
  completedAt   DateTime?
  steps         Step[]
  reasoningJobs ReasoningJob[]

  @@index([projectId])
  @@index([executionId])
  @@index([startedAt])
}

// Individual step within an execution
model Step {
  id            String      @id @default(cuid())
  executionId   String
  execution     Execution   @relation(fields: [executionId], references: [id], onDelete: Cascade)
  name          String
  input         Json?
  output        Json?
  error         String?
  durationMs    Int?
  reasoning     String?
  createdAt     DateTime    @default(now())

  @@index([executionId])
  @@index([name])
}

// Reasoning job queue (for async reasoning generation)
model ReasoningJob {
  id            String      @id @default(cuid())
  executionId   String
  execution     Execution   @relation(fields: [executionId], references: [id], onDelete: Cascade)
  stepName      String
  status        String      // 'pending' | 'processing' | 'completed' | 'failed'
  reasoning     String?
  error         String?
  attempts      Int         @default(0)
  createdAt     DateTime    @default(now())
  completedAt   DateTime?

  @@index([status])
  @@index([executionId, stepName])
  @@unique([executionId, stepName])
}
